


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Prismatopia documentation">
      
      
      
        <meta name="author" content="Bernie Durfee (Lambda School Labs)">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.0.2">
    
    
      
        <title>Apollo Layer - Prismadocia</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.07c9fbf5.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#the-apollo-layer" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Prismadocia" class="md-header-nav__button md-logo" aria-label="Prismadocia">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Prismadocia
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Apollo Layer
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/Lambda-School-Labs/prismadocia/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Prismadocia" class="md-nav__button md-logo" aria-label="Prismadocia">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    Prismadocia
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/Lambda-School-Labs/prismadocia/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Apollo Layer
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,9H17V7H3V9M3,13H17V11H3V13M3,17H17V15H3V17M19,17H21V15H19V17M19,7V9H21V7H19M19,13H21V11H19V13Z" /></svg>
        </span>
      </label>
    
    <a href="./" title="Apollo Layer" class="md-nav__link md-nav__link--active">
      Apollo Layer
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setting-up-okta" class="md-nav__link">
    Setting up Okta
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cherry-picking-from-the-prisma-api" class="md-nav__link">
    Cherry picking from the Prisma API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#local-apollo-make-targets" class="md-nav__link">
    Local Apollo Make Targets
  </a>
  
    <nav class="md-nav" aria-label="Local Apollo Make Targets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make-apollo-build" class="md-nav__link">
    make apollo-build
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-apollo-push" class="md-nav__link">
    make apollo-push
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-apollo-token" class="md-nav__link">
    make apollo-token
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../prisma/" title="Prisma Layer" class="md-nav__link">
      Prisma Layer
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../aws/" title="AWS Layer" class="md-nav__link">
      AWS Layer
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setting-up-okta" class="md-nav__link">
    Setting up Okta
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cherry-picking-from-the-prisma-api" class="md-nav__link">
    Cherry picking from the Prisma API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#local-apollo-make-targets" class="md-nav__link">
    Local Apollo Make Targets
  </a>
  
    <nav class="md-nav" aria-label="Local Apollo Make Targets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make-apollo-build" class="md-nav__link">
    make apollo-build
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-apollo-push" class="md-nav__link">
    make apollo-push
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-apollo-token" class="md-nav__link">
    make apollo-token
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Lambda-School-Labs/prismadocia/edit/master/docs/apollo.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>
                  </a>
                
                
                  
                
                
                <h1 id="the-apollo-layer">The Apollo Layer<a class="headerlink" href="#the-apollo-layer" title="Permanent link">&para;</a></h1>
<p>Once you have your Prisma datamodel setup, you'll need to start working on Apollo. Remember, your clients will <em>only</em> ever connect to Apollo, never to Prisma. Prisma is far too wide-open to expose to external clients (web apps, mobile apps, etc).</p>
<h2 id="setting-up-okta">Setting up Okta<a class="headerlink" href="#setting-up-okta" title="Permanent link">&para;</a></h2>
<p>Apollo has built-in support for authentication using an OIDC compliant identity provider. This example will focus on using Okta, but Auth0 has also been proven to work.</p>
<ol>
<li>Create a new Okta developer account at <a href="https://developer.okta.com">https://developer.okta.com</a></li>
<li>Note your Okta domain, it will be something like: <code>https://dev-123456-admin.okta.com/</code></li>
<li>Set the values for the following environment variables in your <code>.env</code> file:<ul>
<li>APOLLO_TOKEN_ENDPOINT</li>
<li><code>https://&lt;your okta domain&gt;/oauth2/default/v1/token</code></li>
<li>APOLLO_JWKS_URI</li>
<li><code>https://&lt;your okta domain&gt;/oauth2/default/v1/keys</code></li>
<li>APOLLO_JWT_ISSUER</li>
<li><code>https://&lt;your okta domain&gt;/oauth2/default</code></li>
</ul>
</li>
<li>Add a new Native application<ul>
<li>Enable Authorization Code and Resource Owner Password grant types</li>
<li>Set the following environment variabels in your <code>.env</code> file:</li>
<li>APOLLO_CLIENT_ID<ul>
<li>The Client ID for your application</li>
</ul>
</li>
<li>APOLLO_CLIENT_SECRET<ul>
<li>The Client Secret for your application</li>
</ul>
</li>
</ul>
</li>
<li>Create a test user and save the username and password in your <code>.env</code> file:<ul>
<li>APOLLO_TEST_USERNAME</li>
<li>APOLLO_TEST_PASSWORD</li>
</ul>
</li>
<li>At this point your should be able to successfully run <code>make apollo-token</code><ul>
<li>You can use this token in the Apollo playground: <a href="http://localhost:8000">http://localhost:8000</a></li>
</ul>
</li>
</ol>
<h2 id="cherry-picking-from-the-prisma-api">Cherry picking from the Prisma API<a class="headerlink" href="#cherry-picking-from-the-prisma-api" title="Permanent link">&para;</a></h2>
<p>Your Apollo API (the one your clients <em>will</em> talk to) will end up being be a small subset of your Prisma API. You'll only expose the parts of the Prisma API that your clients need and will leave the rest hidden to the world. This will keep your Apollo API development (and testing) to a minimum.</p>
<ol>
<li>Get Prismatopia running: <code>make local-up</code></li>
<li>Run <code>make prisma-generate</code> and review the generated GraphQL schema: <code>apollo/schema/generated/prisma.graphql</code>. Identify a Prisma API call you want to expose to the world. We'll choose <code>Query.users</code> for this example.</li>
<li>
<p>Edit <code>apollo/schema/apollo.graphql</code> and import only that query:</p>
<div class="highlight"><pre><span></span><code>  # import Query.users from &quot;generated/prisma.graphql&quot;
</code></pre></div>

</li>
<li>
<p>As soon as you save the Apollo schema, <code>nodemon</code> will detect the change and will restart Apollo. Nice, right?</p>
</li>
<li>
<p>Now, you need to create a resolver for this type, which you'll do by creating a resolver function in <code>apollo/src/resolvers/Query.js</code></p>
<div class="highlight"><pre><span></span><code>  <span class="kr">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_parent</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Pass this call directly through to Prisma and return the result</span>
    <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">prisma</span><span class="p">.</span><span class="nx">users</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre></div>

<p>Note, this is but a simple example. While you may end up just passing many API calls straight through to Prisma, there will also be many times where your Apollo resolvers will contain business logic for data validation, authorization, etc.</p>
</li>
</ol>
<p>At this point, you can continue to iterate between cherry picking Prisma API types and implementing resolvers. The key to this process is that there is a single shared datamodel between Apollo and Prisma, which makes using the Prisma client seamless.</p>
<p>You should <em>never</em> redefine types that are already defined in Prisma, though you may want to extend them or create new types if your Apollo resovers talk to APIs other than Prisma.</p>
<h2 id="local-apollo-make-targets">Local Apollo Make Targets<a class="headerlink" href="#local-apollo-make-targets" title="Permanent link">&para;</a></h2>
<h3 id="make-apollo-build"><code>make apollo-build</code><a class="headerlink" href="#make-apollo-build" title="Permanent link">&para;</a></h3>
<p>Builds the Apollo Docker image</p>
<h3 id="make-apollo-push"><code>make apollo-push</code><a class="headerlink" href="#make-apollo-push" title="Permanent link">&para;</a></h3>
<p>Builds and pushes the Apollo Docker image to the Docker repository specified by APOLLO_CONTAINER_IMAGE</p>
<h3 id="make-apollo-token"><code>make apollo-token</code><a class="headerlink" href="#make-apollo-token" title="Permanent link">&para;</a></h3>
<p>Generates a JWT for authenticating to Apollo. Very handy for testing!</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href=".." title="Overview" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Overview
              </div>
            </div>
          </a>
        
        
          <a href="../prisma/" title="Prisma Layer" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Prisma Layer
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z" /></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.36cbf620.min.js"></script>
      <script src="../assets/javascripts/bundle.00c583dd.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.7f7c8775.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>